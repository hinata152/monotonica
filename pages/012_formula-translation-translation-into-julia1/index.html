<!doctype html> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=preconnect  href="https://fonts.googleapis.com"> <link rel=preconnect  href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&family=Zen+Kaku+Gothic+New:wght@500&display=swap" rel=stylesheet > <link rel=stylesheet  href="/monotonica/libs/katex/katex.min.css"> <link rel=stylesheet  href="/monotonica/libs/highlight/github.min.css"> <link rel=stylesheet  href="/monotonica/css/franklin.css"> <link rel=stylesheet  href="/monotonica/css/poole_lanyon.css"> <link rel=stylesheet  href="/monotonica/css/adjust.css"> <link rel=icon  href="/monotonica/assets/favicon.png"> <title>FORmula-TRANslation Translation into Julia (1)</title> <input type=checkbox  class=sidebar-checkbox  id=sidebar-checkbox > <div class=sidebar  id=sidebar > <div class=sidebar-item > <p>A theme adapted from <a href="http://lanyon.getpoole.com/" target=_blank >Lanyon</a>.</p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/monotonica/">Home</a> <a class="sidebar-nav-item " href="/monotonica/about/">About</a> <a class="sidebar-nav-item " href="/monotonica/tag/tech/">Tech</a> <a class="sidebar-nav-item " href="/monotonica/tag/misc/">Misc</a> <a class="sidebar-nav-item " href="/monotonica/mono-research/">Research</a> <a class="sidebar-nav-item " href="/monotonica/license-monotonica/">License</a> </nav> <div class=sidebar-item > <p>&copy; hinagata.</p> </div> </div> <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. --> <div class=wrap > <div class=masthead > <div class=container > <h3 class=masthead-title > <a href="/monotonica/" title=Home >monotonica</a> <small>Engimono Notebook and more</small> </h3> </div> </div> <div class="container content"> <div class=franklin-content > <h1 id=formula-translation_translation_into_julia_1 ><a href="#formula-translation_translation_into_julia_1" class=header-anchor >FORmula-TRANslation Translation into Julia &#40;1&#41;</a></h1> <p>FORTRANをJuliaに翻訳します。その1</p> <div class=franklin-toc ><ol><li><a href="#はじめに">はじめに</a><li><a href="#incompressible_couette_flow">Incompressible Couette Flow</a><li><a href="#ソースコードのかきなおし">ソースコードのかきなおし</a><li><a href="#おわりに">おわりに</a></ol></div> <h2 id="はじめに"><a href="#はじめに" class=header-anchor >はじめに</a></h2> <blockquote class=twitter-tweet ><p lang=ja  dir=ltr >とみやさんはその後、日本語で Julia in Physics という会議を開かれていて、こちらも動画が残ってるのでぜひ。物理以外でも役に立つ内容かと思います。<a href="https://t.co/Cx4nMZn8T7">https://t.co/Cx4nMZn8T7</a></p>&mdash; oka ఒక (@nowohyeah) <a href="https://twitter.com/nowohyeah/status/1439196915233558528?ref_src=twsrc%5Etfw">September 18, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset=utf-8 ></script> <p><a href="https://interaxion-podcast.github.io/">Interaxion Podcast</a>の<a href="https://interaxion-podcast.github.io/24">ep.24</a>をきっかけに教えてもらった<a href="https://akio-tomiya.github.io/julia_in_physics/">Julia in Physics 2021</a>という研究会を追っていたら、FortranからJuliaを始めたい人向けの講演を見つけた。JuliaConと同様に講演アーカイブ動画が残っていてありがたい。</p> <iframe width=560  height=315  src="https://www.youtube-nocookie.com/embed/88P5kOy4E78" title="YouTube video player" frameborder=0  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> <p>講演動画と併せて同じ著者による<a href="https://cometscome.github.io/JuliaFromFortran/build/">Fortranから始めるJulia</a>というウェブサイトも公開されている。 サイト内で辿れる<a href="https://cometscome.github.io/JuliaFromFortran/build/chapter2/01/">FortranのコードをJuliaへ移植してみる</a>のページにある移植事例を参考に、手持ちのいにしえのFORTRANコードをJuliaに翻訳してみた。</p> <h2 id=incompressible_couette_flow ><a href="#incompressible_couette_flow" class=header-anchor >Incompressible Couette Flow</a></h2> <p>手頃なFORTRANコードを探すのに少し苦労したけど、<a href="https://www.amazon.co.jp/dp/0071132104">とある古文書</a>を紐解いて一つ見繕うことができた。</p> <p>本書第9章では非圧縮性流体の<a href="https://ja.wikipedia.org/wiki/&#37;E3&#37;82&#37;AF&#37;E3&#37;82&#37;A8&#37;E3&#37;83&#37;83&#37;E3&#37;83&#37;88&#37;E6&#37;B5&#37;81&#37;E3&#37;82&#37;8C">クエット流れ</a>を取り扱っている。 クエット流れは厳密解の存在する粘性流れ。 ウィキペディアによれば巽流体力学にも記述があるらしいけど、僕はまだ読んだ記憶がない気がする。 クエット流れの壁面水平方向速度 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex"> u </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">u</span></span></span></span> はナビエ・ストークス方程式から得られる以下の式で表される。</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mfrac><mrow><msup><mi mathvariant=normal >∂</mi><mn>2</mn></msup><mi>u</mi></mrow><mrow><mi mathvariant=normal >∂</mi><msup><mi>y</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex"> \dfrac{\partial^2 u}{\partial y^2} = 0 </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.371548em;vertical-align:-0.8804400000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.491108em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal">u</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span></span></span></span></span> <p>この式は実質的には2階常微分方程式なので、積分すればたやすく解を得ることができて、速度 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex"> u </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">u</span></span></span></span> は壁からの距離に応じた直線分布となる。</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>u</mi><mo>=</mo><msub><mi>c</mi><mn>1</mn></msub><mi>y</mi><mo>+</mo><msub><mi>c</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex"> u = c_1y+c_2 </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <p>この速度分布を得るいにしえのFORTRANコードは本書Appendix Aに掲載されている。 Appendixの章題にもある通り、三重対角行列を解くアルゴリズムは<a href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">Thomas algorithm</a>として知られていて、このアルゴリズムを使った解法になる。 行数にして全部で63行しかないし、そんなに大変な作業ではないだろう……と高をくくっていたら、Juliaの文法をだいぶ忘れてしまっていて案外手こずった。 本当はもう少し複雑なコードを翻訳しようと思っていたけど、このレベルから始めて良かった。</p> <h2 id="ソースコードのかきなおし"><a href="#ソースコードのかきなおし" class=header-anchor >ソースコードのかきなおし</a></h2> <p>基本的には前述した<a href="https://cometscome.github.io/JuliaFromFortran/build/chapter2/01/">FortranのコードをJuliaへ移植してみる</a>のページ、特に終わりにあるチェックリストに沿って変更していけば問題ない。 例えば以下に示すメインループ部分（一部省略）について、変更前のFORTRANのコードと、変更後のJuliaのコードをそれぞれ示す。</p> <pre><code class="julia hljs">DO5 KK=<span class=hljs-number >1</span>,KKEND
C     SET ORIGINAL COEFFICIENTS
      DO2 J=<span class=hljs-number >2</span>,N
      Y(J)=Y(J-<span class=hljs-number >1</span>)+DEL
      A(J)=AA
      IF(J.EQ.N) A(J)=<span class=hljs-number >0.0</span>
      （...中略...）
C     UPPER BIDIAGONAL FORM
      DO3 J=<span class=hljs-number >3</span>,N
      D(J)=D(J)-B(J)*A(J-<span class=hljs-number >1</span>)/D(J-<span class=hljs-number >1</span>)
      C(J)=C(J)-C(J-<span class=hljs-number >1</span>)*B(J)/D(J-<span class=hljs-number >1</span>)
<span class=hljs-number >3</span>     CONTINUE
      （...中略...）
      TEST=MOD(KK,KKMOD)
      IF(TEST.GT<span class=hljs-number >.0</span><span class=hljs-number >.01</span>) GO TO <span class=hljs-number >5</span>
      WRITE(<span class=hljs-number >6</span>,<span class=hljs-number >100</span>) KK,TIME,DELTIM
      WRITE(*,<span class=hljs-number >100</span>) KK,TIME,DELTIM
      WRITE(<span class=hljs-number >6</span>,<span class=hljs-number >101</span>)
      WRITE(*,<span class=hljs-number >101</span>)
      WRITE(<span class=hljs-number >6</span>,<span class=hljs-number >102</span>) (J,Y(J),U(J),B(J),D(J),A(J),C(J),J=<span class=hljs-number >1</span>,NN)
      WRITE(*,<span class=hljs-number >102</span>) (J,Y(J),U(J),B(J),D(J),A(J),C(J),J=<span class=hljs-number >1</span>,NN)
<span class=hljs-number >5</span>     CONTINUE</code></pre> <span style="font-size: 80%">John David Anderson, "Computational Fluid Dynamics: The Basics With Applications," McGraw-Hill Inc. (1995), p.538.</span> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> KK=<span class=hljs-number >1</span>:KKEND
    <span class=hljs-comment ># SET ORIGINAL COEFFICIENTS</span>
    <span class=hljs-keyword >for</span> J=<span class=hljs-number >2</span>:N
        Y[J]=Y[J-<span class=hljs-number >1</span>]+DEL
        A[J]=AA
        <span class=hljs-keyword >if</span> J==N
            A[J]=<span class=hljs-number >0.0</span>
        <span class=hljs-keyword >end</span>
    （...中略...）
    <span class=hljs-comment ># UPPER BIDIAGONAL FORM</span>
    <span class=hljs-keyword >for</span> J=<span class=hljs-number >3</span>:N
        D[J]=D[J]-B[J]*A[J-<span class=hljs-number >1</span>]/D[J-<span class=hljs-number >1</span>]
        C[J]=C[J]-C[J-<span class=hljs-number >1</span>]*B[J]/D[J-<span class=hljs-number >1</span>]
    <span class=hljs-keyword >end</span>
    （...中略...）
    TEST=KK%KKMOD
    <span class=hljs-keyword >if</span> TEST&lt;<span class=hljs-number >0.01</span>
        println(<span class=hljs-string >&quot;SOLUTION AT     KK=  <span class=hljs-variable >$KK</span>     TIME= <span class=hljs-variable >$TIME</span>     DELTIM= <span class=hljs-variable >$DELTIM</span>&quot;</span>)
        println(<span class=hljs-string >&quot;&quot;</span>)
        println(<span class=hljs-string >&quot;   J      Y         U         B         D         A         C&quot;</span>)
        <span class=hljs-keyword >for</span> J=<span class=hljs-number >1</span>:NN
            <span class=hljs-meta >@printf</span> <span class=hljs-string >&quot;%2i %10.3e %10.3e %10.3e %10.3e %10.3e %10.3e\n&quot;</span> J Y[J] U[J] B[J] D[J] A[J] C[J]
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre> <p>主なポイントと気付き事項は以下。</p> <ul> <li><p>前述のウェブサイトで示されている通り、累乗は<code>^</code>、余り計算は<code>&#37;</code>に置き換え</p> <li><p>配列の添字は丸括弧<code>&#40;&#41;</code>から角括弧<code>&#91;&#93;</code>に修正する。演算中の丸括弧を含めないよう、適当な添字入りでの一括置換を何度か繰り返せばOK</p> <li><p><code>DO</code>を<code>for</code>に直すのはいいとして、<code>IF</code>を<code>if</code>（小文字表記）に修正しないといけないのは盲点だった。</p> <li><p>if文は1行で書くのをやめて<code>end</code>で閉じる必要がある。</p> <li><p>出力のformattingに少し苦労した。<code>println</code>では見た目よく揃えるのが難しそうだったので、ここではPrintfパッケージを使った。<a href="http://www.nct9.ne.jp/m_hiroi/light/juliaa06.html">（参考）</a></p> <ul> <li><p><code>using Printf</code>からの<code>@printf</code>で出力。桁数はお好みで</p> <li><p>いにしえのフォーマッティング<code>e10.3</code>は<code>10.3e</code>に、<code>i2</code>は<code>2i</code>になる。いま試したらzero paddingの<code>i2.2</code>→<code>2.2i</code>もいける。</p> <li><p>そして先頭にパーセント<code>&#37;</code>をつけるのを忘れない：<code>&#37;10.3e</code>, <code>&#37;2i</code>, <code>&#37;2.2i</code></p> </ul> <li><p>いろいろと試行錯誤するのにJuliaでコンパイルが不要になるのは本当に楽。</p> </ul> <p>ソースコードを実行すると<code>KKEND</code>で指定した回数だけ反復計算がなされ、その過程では<code>KKMOD</code>で指定した間隔で出力がなされる。 今回の計算は一瞬で終わってしまい、FORTRANとJuliaでの実行速度の比較はできなかった。</p> <p>FORTRANとJuliaの両者で出力は<strong>概ね</strong>一致することを確認している。 このご時世に単精度演算とする意味はないと思って、Juliaへの翻訳時に倍精度演算に直していることから、誤差の丸めに影響が出ている。 有効桁数の観点からは表示桁数ももう少し増やしても問題ない。</p> <p>反復回数による速度分布の変化をグラフに示した。縦軸に速度、横軸に壁からの距離を取っている。100ステップではまだ収束が甘く、200ステップ回せばほぼ直線分布が得られる。 パラメータを変更すればステップ数をもう少し削れるかもしれない。</p> <p><img src="/monotonica/pages/img/20211011061830.png" alt=u-profile  /></p> <p>グラフはJuliaの<code>Plots</code>パッケージで書ければ良かったのだけれど、今はそのやり方すらも忘れていた。 文法でいえば、1年前に少し触ったはずのJuliaの文法はほとんど忘れていた一方で、数年単位で書いていないはずのFortranの文法はちゃんと覚えていて、これが母国語か……となった。</p> <h2 id="おわりに"><a href="#おわりに" class=header-anchor >おわりに</a></h2> <p>手持ちのいにしえのFORTRANコードを練習がてらJuliaに翻訳した。 これを取っ掛かりにしてもう少しJuliaっぽいコードを扱えるようになれると良い。</p> <div class=page-foot > <div class=copyright > &copy; hinagata. Last modified: May 04, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> <label for=sidebar-checkbox  class=sidebar-toggle ></label>